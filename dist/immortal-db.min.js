/*! For license information please see immortal-db.min.js.LICENSE.txt */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.ImmortalDB=e():t.ImmortalDB=e()}(self,(()=>(()=>{var t={808:(t,e,r)=>{var o,s;!function(n){if(void 0===(s="function"==typeof(o=n)?o.call(e,r,e,t):o)||(t.exports=s),!0,t.exports=n(),!!0){var i=window.Cookies,a=window.Cookies=n();a.noConflict=function(){return window.Cookies=i,a}}}((function(){function t(){for(var t=0,e={};t<arguments.length;t++){var r=arguments[t];for(var o in r)e[o]=r[o]}return e}function e(t){return t.replace(/(%[0-9A-Z]{2})+/g,decodeURIComponent)}return function r(o){function s(){}function n(e,r,n){if("undefined"!=typeof document){"number"==typeof(n=t({path:"/"},s.defaults,n)).expires&&(n.expires=new Date(1*new Date+864e5*n.expires)),n.expires=n.expires?n.expires.toUTCString():"";try{var i=JSON.stringify(r);/^[\{\[]/.test(i)&&(r=i)}catch(t){}r=o.write?o.write(r,e):encodeURIComponent(String(r)).replace(/%(23|24|26|2B|3A|3C|3E|3D|2F|3F|40|5B|5D|5E|60|7B|7D|7C)/g,decodeURIComponent),e=encodeURIComponent(String(e)).replace(/%(23|24|26|2B|5E|60|7C)/g,decodeURIComponent).replace(/[\(\)]/g,escape);var a="";for(var c in n)n[c]&&(a+="; "+c,!0!==n[c]&&(a+="="+n[c].split(";")[0]));return document.cookie=e+"="+r+a}}function i(t,r){if("undefined"!=typeof document){for(var s={},n=document.cookie?document.cookie.split("; "):[],i=0;i<n.length;i++){var a=n[i].split("="),c=a.slice(1).join("=");r||'"'!==c.charAt(0)||(c=c.slice(1,-1));try{var u=e(a[0]);if(c=(o.read||o)(c,u)||e(c),r)try{c=JSON.parse(c)}catch(t){}if(s[u]=c,t===u)break}catch(t){}}return t?s[t]:s}}return s.set=n,s.get=function(t){return i(t,!1)},s.getJSON=function(t){return i(t,!0)},s.remove=function(e,r){n(e,"",t(r,{expires:-1}))},s.defaults={},s.withConverter=r,s}((function(){}))}))}},e={};function r(o){var s=e[o];if(void 0!==s)return s.exports;var n=e[o]={exports:{}};return t[o](n,n.exports,r),n.exports}r.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return r.d(e,{a:e}),e},r.d=(t,e)=>{for(var o in e)r.o(e,o)&&!r.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:e[o]})},r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),r.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var o={};return(()=>{"use strict";r.r(o),r.d(o,{CookieStore:()=>h,DEFAULT_DATABASE_NAME:()=>w,DEFAULT_KEY_PREFIX:()=>x,DEFAULT_STORES:()=>k,DEFAULT_STORE_NAME:()=>_,DEFAULT_VALUE:()=>E,ImmortalDecoderError:()=>s,ImmortalEncoderError:()=>e,ImmortalError:()=>t,ImmortalStorage:()=>D,ImmortalStoresPartialError:()=>n,ImmortalStoresTotalError:()=>i,IndexedDbStore:()=>y,LocalStorageStore:()=>S,SessionStorageStore:()=>g});class t extends Error{constructor(t="ImmortalDB unexpected error"){super(t),this.name="ImmortalError"}}class e extends t{constructor(t="Unable to encode the value to be stored"){super(t),this.name="ImmortalEncoderError"}}class s extends t{constructor(t="Unable to decode the stored value"){super(t),this.name="ImmortalDecoderError"}}class n extends t{constructor(t="Some stores failed to perform operation"){super(t),this.name="ImmortalStoresPartialError"}}class i extends t{constructor(t="All stores failed to perform operation"){super(t),this.name="ImmortalStoresTotalError"}}var a=r(808),c=r.n(a);const u=function(){try{return!window.top.location.href}catch(t){return!0}}(),l=!!u,d=u?"None":"Lax";class h{constructor({ttl:t=365,secure:e=l,sameSite:r=d}={}){return this.ttl=t,this.secure=e,this.sameSite=r,(async()=>this)()}async get(t){const e=c().get(t);return"string"==typeof e?e:void 0}async set(t,e){c().set(t,e,this._constructCookieParams())}async remove(t){c().remove(t,this._constructCookieParams())}_constructCookieParams(){return{expires:this.ttl,secure:this.secure,sameSite:this.sameSite}}}class f{constructor(t="keyval-store",e="keyval"){this.storeName=e,this._dbp=new Promise(((r,o)=>{const s=indexedDB.open(t,1);s.onerror=()=>o(s.error),s.onsuccess=()=>r(s.result),s.onupgradeneeded=()=>{s.result.createObjectStore(e)}}))}_withIDBStore(t,e){return this._dbp.then((r=>new Promise(((o,s)=>{const n=r.transaction(this.storeName,t);n.oncomplete=()=>o(),n.onabort=n.onerror=()=>s(n.error),e(n.objectStore(this.storeName))}))))}}let m;function p(){return m||(m=new f),m}const w="ImmortalDB",_="key-value-pairs";class y{constructor(t=w,e=_){return this.store=new f(t,e),(async()=>{try{await this.store._dbp}catch(t){if("SecurityError"===t.name)return null;throw t}return this})()}async get(t){const e=await function(t,e=p()){let r;return e._withIDBStore("readonly",(e=>{r=e.get(t)})).then((()=>r.result))}(t,this.store);return"string"==typeof e?e:void 0}async set(t,e){await function(t,e,r=p()){return r._withIDBStore("readwrite",(r=>{r.put(e,t)}))}(t,e,this.store)}async remove(t){await function(t,e=p()){return e._withIDBStore("readwrite",(e=>{e.delete(t)}))}(t,this.store)}}class v{constructor(t){return this.store=t,(async()=>this)()}async get(t){const e=this.store.getItem(t);return"string"==typeof e?e:void 0}async set(t,e){this.store.setItem(t,e)}async remove(t){this.store.removeItem(t)}}class S extends v{constructor(){super(window.localStorage)}}class g extends v{constructor(){super(window.sessionStorage)}}const E=void 0,x="_immortal|",k=[h],b=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==r.g)return r.g;throw new Error("unable to locate global object")}();try{b&&b.indexedDB&&k.push(y)}catch(t){}try{b&&b.localStorage&&k.push(S)}catch(t){}const I="fulfilled",P=t=>t;class D extends EventTarget{constructor(t=k,e=x,r=E,o=P,s=P){super(),this._encoder=o||P,this._decoder=s||P,this._defaultValue=r,this._keyPrefix=e??x,this._stores=[],this._locks=new Map,this.onReady=(async()=>{const e=await Promise.allSettled(t.map((t=>{if("function"!=typeof t)return t;try{return new t}catch(t){return Promise.reject(t)}})));return this._stores=e.filter((t=>t.status===I)).map((t=>t.value)).filter((t=>t)),0===this._stores.length?Promise.reject(new Error("Unable to construct any store")):Promise.resolve()})()}_createErrorFromSettledPromises(t,e){const r=t.filter((t=>"rejected"===t.status)).map((t=>t.reason instanceof Error?t.reason.message:String(t.reason)));if(r.length>0){const t=this._stores.length===r.length,o=[`${t?"All":"Some"} stores failed to ${e}(). Store errors:`,...r.map((t=>`    * "${t}"`))].join("\n");return new(t?i:n)(o)}}async _lock(t){if(!this._acquireLock(t))return new Promise((e=>{this.addEventListener(t,(function r(){this._acquireLock(t)&&(this.removeEventListener(t,r),e())}))}))}async _unlock(t){this._locks.delete(t),this.dispatchEvent(new Event(t))}_prefix(t){return`${this._keyPrefix}${t}`}_acquireLock(t){return!this._locks.has(t)&&(this._locks.set(t,!0),!0)}async get(t,e=this._defaultValue){await this._lock(t);try{const r=await this._get(t,e);return await this._unlock(t),r}catch(e){throw await this._unlock(t),e}}async _get(t,r=this._defaultValue){await this.onReady;const o=this._prefix(t),n=await Promise.allSettled(this._stores.map((t=>t.get(o)))),i=function(t){let e=0;const r=Object.create(null);t.forEach((t=>{if(null==t)return void(e+=1);const o=r[t]||0;r[t]=o+1}));const o=Object.entries(r);return e&&o.push([void 0,e]),o}(n.filter((t=>t.status===I)).map((t=>t.value)));i.sort(((t,e)=>t[1]<=e[1]));const a=i.filter((([t])=>void 0!==t&&"undefined"!==t));if(0===a.length){return this._createErrorFromSettledPromises(n,"get")||await this._remove(t),r}const[c]=a[0];let u;try{u=await this._decoder(c)}catch(t){throw new s}try{await this._set(t,u)}catch(t){if(t instanceof e)throw t}return u}async set(t,e){await this._lock(t);try{const r=await this._set(t,e);return await this._unlock(t),r}catch(e){throw await this._unlock(t),e}}async _set(t,r){await this.onReady;const o=this._prefix(t);let s;try{s=await this._encoder(r)}catch(t){throw new e}if(void 0===s||"undefined"===s)throw new e('Unable to store encoded value "undefined"');const n=await Promise.allSettled(this._stores.map((t=>t.set(o,s)))),i=this._createErrorFromSettledPromises(n,"set");if(i)throw i;const a=await Promise.allSettled(this._stores.map((t=>t.get(o).then((t=>{if(t&&"undefined"!==t&&t!==s)return Promise.reject(new Error("Integrity check failed"))}))))),c=this._createErrorFromSettledPromises(a,"set");if(c)throw c;return r}async remove(t){await this._lock(t);try{const e=await this._remove(t);return await this._unlock(t),e}catch(e){throw await this._unlock(t),e}}async _remove(t){await this.onReady;const e=this._prefix(t),r=await Promise.allSettled(this._stores.map((t=>t.remove(e)))),o=this._createErrorFromSettledPromises(r,"remove");if(o)throw o;return this._defaultValue}}})(),o})()));